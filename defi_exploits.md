### References



1. [https://consensys.github.io/smart-contract-best-practices/attacks/](https://consensys.github.io/smart-contract-best-practices/attacks/)

    Price oracle

2. [https://samczsun.com/so-you-want-to-use-a-price-oracle/](https://samczsun.com/so-you-want-to-use-a-price-oracle/)
    1. [https://messari.io/article/amm-braindump](https://messari.io/article/amm-braindump)
    2. [https://samczsun.com/taking-undercollateralized-loans-for-fun-and-for-profit/](https://samczsun.com/taking-undercollateralized-loans-for-fun-and-for-profit/)

    TWAP attacks

3. [https://rekt.news/inverse-finance-rekt/](https://rekt.news/inverse-finance-rekt/)
4. [https://eprint.iacr.org/2022/445.pdf](https://eprint.iacr.org/2022/445.pdf)

The short history of decentralized finance has already seen numerous exploits and hacks that have seen millions of dollars in losses. The following categorization of these attacks provided by [consensys](https://consensys.github.io/smart-contract-best-practices/attacks/) serves as a useful starting point for exploring defi attacks.


![alt_text](images/image1.png "image_tooltip")



## Price manipulation exploits

A Defi application that uses price data does so from one of the following sources:



* On-chain data (as done by Uniswap, Balancer, Squeeth): These exploits involve manipulating prices by making large trades and creating imbalance in liquidity pools.
* Off-chain data (as done by Synthetix): Also known as Oracle hacks, these exploits may take advantage of malfunctions in the data retrieval or errors passed on from the off-chain sources.

The following sections describe specific instances of price attacks/oracle attacks that the defi ecosystem has witnessed in recent times.


### Example: The Synthetix oracle exploit

Synthetix is a derivatives protocol that allows users to gain exposure to various kinds of on-chain or off-chain assets such as forex, crypto and commodities (gold, silver, etc). This is achieved by the creation and trading of _synths; _derivatives which follow the price movements of underlying assets using asset price data. At the time, this data was aggregated from _secret_ commercial price feeds and posted on the chain at periodic intervals. On June 25, 2019, one of the price feeds that Synthetix relied on mis-reported the price of the Korean Won to be 1000x higher than the true rate. This prompted an arbitrage bot to quickly take advantage of this price discrepancy and make a series of trades (buy sWon low outside -> sell high at synthetix). Due to the synthetix dex offering automated markets and low slippage, the attacker was able to sell his won and cash out with almost 1 billion USD. According to Synthetix’s official statement;


### “Our price oracle has a mechanism for discarding outliers and should have absorbed this discrepancy gracefully, unfortunately the price feed for KRW was only being served by two API’s at that time due to an earlier unrelated outage which had not been caught by our exception reporting. This meant the Oracle took an average of the only two remaining prices which caused it to misreport the price of KRW to our exchange rates contract”


### Example: DDEX oracle manipulation bot [by samczsun](https://samczsun.com/taking-undercollateralized-loans-for-fun-and-for-profit/)

DDEX was a decentralized exchange that also began rolling out decentralized lending. As a part of this, they launched ETH/DAI lending in late 2019. This allowed users to borrow ETH, holding DAI as collateral. The prices of ETH and DAI were taken from several on-chain feeds.  The value of ETH/USD was read from the Maker oracle, while the value of ETH/DAI was read from either Eth2Dai, or if the spread was too great; from Uniswap. Samczsun came up with the following exploit path that relied on Uniswap’s volatile pricing due to its invariant rule-based pricing;



1. Force oracle to bypass Eth2Dai price by creating a large spread (by clearing out orders on either buy side or sale side)
2. Buy large amounts of DAI from ETH/DAI pool in Uniswap, forcing it to drive up the price of DAI in terms of ETH.
3. Using this price to loan large amounts of ETH for small amount of DAI

<span style="text-decoration:underline;">Vulnerabilities and fixes:</span> The DDEX team eventually patched up this problem by  only allowing Whitelisted tokens as collateral and putting in place several other validation checks, such as sanity check for DAI price (? within range(0.95,1.05).


### Example: 2nd Synthetix oracle exploit (MKR)

In this example, documented by a reddit user, Uniswap price manipulation is used to vary the price of MKR synth on Synthetix and profit from the artificial deviance.



1. The user first buys synthetic Long MKR exposure on Synthetix: [https://etherscan.io/tx/0x729ff883611a2bc85c4ecc933e0e6b6077ab382f08eda4fdbd5eb3c4cac66674](https://etherscan.io/tx/0x729ff883611a2bc85c4ecc933e0e6b6077ab382f08eda4fdbd5eb3c4cac66674)
2. Then buys up about 144 MKR on uniswap, done in 12 chunks of 12 MKR each, presumably to push up the price and profit from his long: [sample1](https://etherscan.io/tx/0x60c38fb7a5d9ee88200d8034b69f45c8f9bb1e2ff95ed9bb74af179a89c1ee8c) [sample2](https://etherscan.io/tx/0x085697d4ed0c8c369c84480ed62dcbb7cd800adbc397c103d68e71cbbc301018)
3. The user then buys synthetic short MKR exposure from Synthetix: [https://etherscan.io/tx/0x6ade376ab03e29236c1cc29d7304cc522772ae900e791ac25ddc46a54ab77af8](https://etherscan.io/tx/0x6ade376ab03e29236c1cc29d7304cc522772ae900e791ac25ddc46a54ab77af8)
4. Then dumps the MKR he just bought, dumping the price and profiting from the short.

This transaction series was being carried out repeatedly throughout the day and the price of MKR was being fluctuated between 3.6 and 3.2


##### Key innovation: 

TWAP pricing, a new standard adopted for getting price information from decentralized exchanges, uses time-weighted average prices over a period (usually 5-10 minutes). This prevents attackers from manipulating prices and profiting within a single transaction.


##### Squeeth potential example: 



1. Mint 2.5 SQTH for 1000 ETH
2. Sell SQTH in Uniswap to reduce SQTH price and increase ETH price**
3. This reduces mark price of SQTH against index price (causing funding rate to reverse or lower)
4. Pay back SQTH loan at reduced price and receive appreciated ETH collateral back

**Uniswap price manipuation may be much harder/impossible given the usage of TWAP, which allows arbitrageurs to correct market immediately after price changes occur. Besides, current pool size of ETH/SQTH is about 10 million dollars, which means a large initial investment would be required to manipulate this price.


### TWAP arbitrage

> TWAP price will lag behind ETH spot price in case of sudden changes

> With one sudden change, TWAP will need at least 240s (4 minutes) to stabilize beyond arbitrage profits

> With continuing spiral, TWAP will be unable to catch up as long as spiral continues

> We can build a bot that continuously calculates twap and monitors targeted pools for sudden changes

> In case of sudden change, bot will be able to see next price for some time using TWAP (effectively predict TWAP price upto 1-5 minutes)


##### Squeeth example:

>>  If ETH spot = 480, TWAP ETH = 410, SQTH spot = 230400, TWAP SQTH = 168100


    So if we buy 1 SQTH at twap price -> wait until price adjusts with market -> sell SQTH


    Profit made = 230400-168100 usd ~ 60k usd


## Speculative currency attack

A speculative currency attack refers to a traditional arbitrage move that takes place under the following circumstances;



1. Currency is being devalued against standard/international/other currency
2. Central bank is buying large amounts of currency to prevent further devaluation

A third possible circumstance is that the currency in question is pegged to the value of either a commodity (ex; gold) or another currency. 

Under these circumstances, an arbitrageur may enter the local currency market -> loan large amounts of local currency -> sell local currency for USD/other -> causing currency to devalue significantly -> thus repaying local currency loan (which is lower now in dollar terms) -> and profiting the rest.

In the crypto space, particularly with pegged currencies, such an attack would assume the form of loaning out a coin, then selling in pools that significantly devalue the coin, then paying back the loan and profiting. 

Synthetix - hedgic - opyn gamma protocol + github defi repo : Overall processes (protocol +  tokenomics + code)

Find yield and staking vaults among options protocols (such as crab strategy is a variable yield protocol) - such as profit sharing vaults that trade options 

Liquidation bot:



* Normal liquidation bot that scans vaults (squeeth) and liquidates undercollateralized bots
* Research liquidation bots from other protocols
* **Define liquidation strategy for squeeth liquidation bots**
* Using uniswp price changes to take advantage of collateral drops